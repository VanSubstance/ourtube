<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper
	namespace = "com.my.spring.mapper.ChannelMapper">
	
	<select 
	id="getChannelsByCtgr"
	parameterType="String"
	resultType="String">
		select A.title from channel A, chainchannel B
		where B.ctgr = #{ctgr} and A.id = B.id
	</select>
	
	<select 
	id="getCtgrsByChannelId"
	parameterType="String"
	resultType="String">
		select ctgr from chainchannel
		where id = #{channelId}
	</select>
	
	<select
	id = "getChannelIdsByDate"
	parameterType="java.sql.Date"
	resultType="String">
		select id from channel where infodate = #{date};
	</select>
	
	<select 
	id="checkExistence"
	parameterType="com.my.spring.domain.ChannelDto"
	resultType="String">
		select title from channel
		where id = #{channel.id} and infodate = #{channel.infoDate}
	</select>
	
	<insert 
	id="putChannelInfo"
	parameterType="com.my.spring.domain.ChannelDto">
		insert into channel (
		id, title, thumbnail, description, publisheddate, 
		videocount, viewcount, subscount, infodate) 
		values (
		#{data.id}, #{data.title}, #{data.thumbnail}, #{data.description}, #{data.publishedDate}, 
		#{data.videoCount}, #{data.viewCount}, #{data.subsCount}, #{data.infoDate})
	</insert>
	
	<insert 
	id="addChainRaw"
	parameterType="com.my.spring.domain.ChainDto">
		insert into chainchannel (
		id, ctgr)
		values (
		#{chain.id}, #{chain.ctgr})
	</insert>
	
	<insert id="addChain"
	parameterType="java.util.Map">
		<foreach 
		collection="chains"
		item = "chain"
		index = "index"
		separator=" "
		open = "insert all"
		close="select * from dual">
			into chainchannel (id, ctgr) values (
			#{chain.id}, (select title from ctgrdictionary where code = #{chain.ctgr})
			)
		</foreach>
	</insert>
	
	<delete id="cleanChain">
		<![CDATA[
		delete from chainchannel
		where id 
		in (select id from channel where videocount <= 100 or viewcount <= 10000 or subscount <= 1000)
		]]>
	</delete>
	
	<delete id="cleanChannel">
		<![CDATA[
		delete from channel
		where
		videocount <= 100
		or viewcount <= 10000
		or subscount <= 1000
		]]>
	</delete>
	
	<select id="getChannelIdsByCtgr" parameterType="String" resultType="String">
		select id from (select b.id from chainchannel b
		where b.ctgr = #{ctgr}) group by id
	</select>
</mapper>